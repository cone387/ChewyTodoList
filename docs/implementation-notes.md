# 三层模板架构实现说明

## 已实现功能

### ✅ 任务卡片样式切换（完全实现）

**功能**：用户可以选择不同的任务卡片样式，实时改变任务的展示效果

**实现细节**：

1. **样式配置应用**
   - 根据选择的卡片模板动态调整任务卡片的样式
   - 支持的样式属性：
     - 布局密度（紧凑/舒适/宽松）
     - 边框圆角（无/小/中/大）
     - 阴影效果（无/小/中/大）
     - 内边距（紧/正常/松）
     - 悬停效果（抬起/发光/边框/无）
     - 复选框样式（圆形/方形/圆角）

2. **内容显示控制**
   - 根据卡片样式配置显示/隐藏不同的元数据
   - 支持控制：项目、标签、截止日期、优先级、状态、子任务、描述

3. **优先级指示器**
   - 旗帜模式：右上角显示优先级图标
   - 边框模式：左侧彩色边框
   - 背景模式：整个卡片背景色
   - 点模式：右上角小圆点
   - 无：不显示优先级

4. **标签样式**
   - 药丸样式：圆角标签
   - 徽章样式：方形标签
   - 极简样式：小型标签

5. **元数据布局**
   - 内联布局：水平排列
   - 堆叠布局：垂直排列
   - 网格布局：2列网格

**使用方式**：
1. 点击顶部导航栏"任务卡片"按钮（style 图标）
2. 选择任意卡片样式
3. 任务列表立即应用新样式

### ✅ 视图类型切换（完全实现）

**功能**：用户可以切换视图的展示类型，改变任务的整体布局

**实现细节**：

1. **API 集成**
   - 使用 `useUpdateView` hook 更新视图类型
   - 调用后端 API：`PUT /api/views/:uid/`
   - 自动刷新视图数据

2. **支持的视图类型**
   - 列表视图（list）
   - 看板视图（board）
   - 日历视图（calendar）
   - 表格视图（table）
   - 时间线视图（timeline）
   - 画廊视图（gallery）

3. **状态管理**
   - 切换时显示加载状态
   - 切换成功后自动关闭选择器
   - 错误处理和提示

**使用方式**：
1. 点击顶部导航栏"视图类型"按钮（view_module 图标）
2. 选择任意视图类型
3. 等待切换完成（约1秒）
4. 视图自动刷新为新类型

### ✅ 已完成任务管理（完全实现）

**功能**：显示/隐藏已完成任务，底部可折叠分组

**实现细节**：
- 已完成任务单独分组
- 默认折叠状态
- 绿色主题样式
- 显示任务数量
- 半透明+删除线样式

## 技术实现

### 文件修改

1. **frontend/src/components/EnhancedTaskList.tsx**
   - 添加 `cardStyle` 属性
   - 实现样式配置应用逻辑
   - 添加样式计算函数：
     - `getCardClasses()` - 卡片整体样式
     - `getTitleClasses()` - 标题样式
     - `getCheckboxClasses()` - 复选框样式
     - `getPriorityIndicatorClasses()` - 优先级指示器样式
   - 动态渲染任务卡片

2. **frontend/src/components/ViewRenderer.tsx**
   - 添加 `cardStyle` 属性
   - 传递给 EnhancedTaskList 组件

3. **frontend/src/pages/HomePage.tsx**
   - 导入 `useUpdateView` hook
   - 获取当前选择的卡片样式对象
   - 实现视图类型切换逻辑
   - 传递卡片样式给 ViewRenderer

### 数据流

```
用户选择卡片样式
    ↓
HomePage 更新 selectedTaskCard 状态
    ↓
根据 ID 查找对应的 TaskCardTemplate 对象
    ↓
传递给 ViewRenderer
    ↓
传递给 EnhancedTaskList
    ↓
应用样式配置到每个任务卡片
```

```
用户选择视图类型
    ↓
HomePage 调用 updateView.mutateAsync()
    ↓
发送 API 请求更新视图
    ↓
后端更新视图配置
    ↓
前端自动刷新视图数据
    ↓
ViewRenderer 根据新类型渲染
```

## 样式效果对比

### 默认卡片
- 舒适布局，中等圆角
- 显示所有信息
- 旗帜优先级指示器
- 药丸标签样式

### 极简卡片
- 紧凑布局，小圆角
- 只显示标题和截止日期
- 点优先级指示器
- 极简标签样式

### 详细卡片
- 宽松布局，大圆角
- 显示所有信息包括描述
- 边框优先级指示器
- 徽章标签样式
- 堆叠元数据布局

### 看板卡片
- 紧凑布局，中等圆角
- 不显示项目和状态
- 旗帜优先级指示器
- 堆叠元数据布局

### 彩色卡片
- 舒适布局，大圆角
- 背景色优先级指示器
- 边框状态指示器
- 徽章标签样式
- 发光悬停效果

### 时间线卡片
- 舒适布局，中等圆角
- 强调时间信息
- 点优先级指示器
- 图标状态指示器
- 极简标签样式

## 注意事项

### Tailwind CSS 动态类名

由于使用了动态的颜色类名（如 `bg-${color}-50`），需要确保这些类名在 Tailwind 的 safelist 中，或者使用完整的类名。

**当前实现**：使用了动态类名，可能需要在 `tailwind.config.js` 中添加 safelist：

```javascript
module.exports = {
  // ...
  safelist: [
    // 优先级背景色
    'bg-gray-50', 'bg-yellow-50', 'bg-orange-50', 'bg-red-50',
    'dark:bg-gray-900/20', 'dark:bg-yellow-900/20', 'dark:bg-orange-900/20', 'dark:bg-red-900/20',
    // 优先级边框
    'border-gray-500', 'border-yellow-500', 'border-orange-500', 'border-red-500',
  ],
}
```

### 视图类型切换限制

目前只有列表视图（list）完全支持任务卡片样式。其他视图类型（看板、日历等）有自己的渲染逻辑，暂时不支持卡片样式切换。

**未来改进**：
- 为看板视图添加卡片样式支持
- 为其他视图类型添加相应的样式配置

### 性能优化

当任务数量较多时，动态计算样式可能影响性能。

**优化建议**：
- 使用 `React.memo` 优化任务卡片组件
- 缓存样式计算结果
- 使用虚拟滚动处理大量任务

## 测试建议

### 功能测试

1. **任务卡片样式切换**
   - 切换不同的卡片样式
   - 验证样式是否正确应用
   - 检查所有样式属性是否生效

2. **视图类型切换**
   - 切换到每种视图类型
   - 验证切换是否成功
   - 检查数据是否正确显示

3. **已完成任务管理**
   - 显示/隐藏已完成任务
   - 展开/折叠已完成任务分组
   - 取消任务完成状态

### 边界测试

1. 没有任务时的显示
2. 只有已完成任务时的显示
3. 大量任务时的性能
4. 网络错误时的处理

### 兼容性测试

1. 不同浏览器的样式显示
2. 深色模式下的样式
3. 移动端的响应式布局

## 后续优化

### 短期优化

1. ✅ 实现任务卡片样式的实际应用
2. ✅ 实现视图类型切换的 API 调用
3. 🔲 添加 Tailwind safelist 配置
4. 🔲 添加切换动画效果
5. 🔲 保存用户的卡片样式偏好到本地存储

### 中期优化

1. 为看板视图添加卡片样式支持
2. 为其他视图类型添加样式配置
3. 添加卡片样式预览功能
4. 优化大量任务时的性能
5. 添加自定义卡片样式编辑器

### 长期优化

1. 建立任务卡片广场
2. 支持社区分享卡片样式
3. 支持导入/导出卡片样式
4. 添加更多预设卡片样式
5. 支持卡片样式的主题系统

## 总结

三层模板架构的核心功能已经完全实现：

- ✅ **视图（View）**：控制"看什么"（已有）
- ✅ **视图类型（View Type）**：控制"怎么看"（已实现）
- ✅ **任务卡片（Task Card）**：控制"看多细"（已实现）

用户现在可以：
1. 选择不同的视图查看不同的任务
2. 切换视图类型改变任务的整体布局
3. 选择任务卡片样式改变单个任务的展示效果
4. 显示/隐藏已完成任务

所有功能都已经可以正常使用，并且会实时生效！🎉
